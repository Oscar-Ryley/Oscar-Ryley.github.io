<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Oscar Ryley</title>
    <link rel="icon" type="image/jpg" href="images/icon.jpg">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
</head>

<body>

    <a href="/" class="back-button" style="position: fixed; top: 20px; right: 20px; z-index: 1000; color: black; background-color: white; border-radius: 50%; width: 40px; height: 40px; display: flex; justify-content: center; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.2);">
        <i class="fa-solid fa-arrow-left"></i>
    </a>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

    <div id="map" style="height: 100vh; width: 100%;"></div>

    <script>
        var UKcoords = [53.766850, -1.766995];
        var NAcoords = [41.791139, -76.547263];

        var map = L.map("map").setView(UKcoords, 6);

        L.tileLayer("https://tile.openstreetmap.org/{z}/{x}/{y}.png", {
            maxZoom: 19,
            attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
        }).addTo(map);

        var UKCluster = L.markerClusterGroup({maxClusterRadius: 30});
        var NACluster = L.markerClusterGroup({maxClusterRadius: 30});

        var hackathonIcon = L.divIcon({
            className: 'event-icon',
            html: '<div style="background-color: #9333ea; width: 15pt; height: 15pt; border-radius: 50%;"></div>',
            iconSize: [50, 50],
            iconAnchor: [5, 5]
        });

        var conferenceIcon = L.divIcon({
            className: 'event-icon',
            html: '<div style="background-color: #3342ea; width: 15pt; height: 15pt; border-radius: 50%;"></div>',
            iconSize: [50, 50],
            iconAnchor: [5, 5]
        });

        async function fetchAndRenderMarkers() {
            try {
                const response = await fetch('./projects.json');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const allProjects = await response.json();

                // Filter for projects that have a 'maps' object
                const mapProjects = allProjects.filter(project => project.maps && project.maps.coords);

                mapProjects.forEach(function(project) {
                    // Access map data from the new 'maps' object
                    const mapData = project.maps;
                    let icon = (mapData.type === "hackathon") ? hackathonIcon : conferenceIcon;

                    let marker = L.marker(mapData.coords, { alt: project.title, icon: icon });

                    let carouselHtml = '<div class="carousel-container">';
                    if (project.images && project.images.length > 0) {
                        project.images.forEach(function(imageName, index) {
                            let imagePath = 'images/map/' + project.imageFolder + '/' + imageName;
                            carouselHtml += '<div class="carousel-slide' + (index === 0 ? ' active' : '') + '">';
                            carouselHtml += '<img src="' + imagePath + '" alt="' + project.title + ' image ' + (index + 1) + '" class="carousel-image" onerror="this.onerror=null;this.src=\'https://placehold.co/600x400/CCCCCC/333333?text=Image+Unavailable\'">';
                            carouselHtml += '</div>';
                        });
                    } else {
                        carouselHtml += '<div class="carousel-slide active"><img src="https://placehold.co/600x400/CCCCCC/333333?text=Image+Unavailable" class="carousel-image"></div>';
                    }

                    if (project.images.length > 1) {
                        carouselHtml += '<div class="carousel-nav-hover left-hover"></div>';
                        carouselHtml += '<div class="carousel-nav-hover right-hover"></div>';
                    }
                    carouselHtml += '</div>';

                    let tagsHtml = '';
                    // Access map tags from the 'maps' object
                    if (mapData.tags && mapData.tags.length > 0) {
                        tagsHtml = '<div style="display: flex; flex-wrap: wrap; gap: 5px;">';
                        tagsHtml += mapData.tags.map(function(tag, index) {
                            let link = mapData.tagLinks && mapData.tagLinks[index] ? mapData.tagLinks[index] : '';
                            let tagClass = mapData.type === "hackathon"
                                ? 'inline-block bg-purple-200 !text-purple-800 text-xs font-semibold px-2 py-1 rounded-full tracking-wide'
                                : 'inline-block bg-blue-200 !text-blue-800 text-xs font-semibold px-2 py-1 rounded-full tracking-wide';

                            if (link.trim() === '') {
                                return '<span class="' + tagClass + '">' + tag + '</span>';
                            } else {
                                return '<a href="' + link + '" class="' + tagClass + '">' + tag + '</a>';
                            }
                        }).join(' ');
                        tagsHtml += '</div>';
                    }

                    let popupHtml = '<div class="custom-popup-content" style="width: 300px;">';
                    popupHtml += carouselHtml;
                    popupHtml += '<h3 class="text-2xl font-bold text-gray-800" style="margin-bottom: 0; margin-top: 1rem;">' + project.title + '</h3>';
                    popupHtml += '<div style="display: flex; justify-content: space-between; align-items: center; margin-top: 0; margin-bottom: 0.2rem;">';
                    popupHtml += '<p class="text-sm text-gray-500" style="margin: 0;">' + project.date + '</p>';
                    popupHtml += tagsHtml;
                    popupHtml += '</div>';
                    // Access map description from the 'maps' object
                    popupHtml += '<p class="text-gray-600">' + mapData.description + '</p>';
                    popupHtml += '</div>';

                    marker.bindPopup(popupHtml, { closeButton: false });

                    const isNA = mapData.coords[0] > 24 && mapData.coords[0] < 50 && mapData.coords[1] < -50;
                    if (isNA) {
                        NACluster.addLayer(marker);
                    } else {
                        UKCluster.addLayer(marker);
                    }

                    marker.on('popupopen', function() {
                        const popup = this.getPopup().getElement();
                        const leftHover = popup.querySelector('.left-hover');
                        const rightHover = popup.querySelector('.right-hover');
                        const carouselContainer = popup.querySelector('.carousel-container');
                        const slides = Array.from(carouselContainer.querySelectorAll('.carousel-slide'));
                        if (leftHover && rightHover && slides.length > 1) {
                            let currentSlideIndex = 0;
                            slides.forEach((slide, index) => {
                                if (slide.classList.contains('active')) {
                                    currentSlideIndex = index;
                                }
                            });
                            const showSlide = (n) => {
                                slides[currentSlideIndex].classList.remove('active');
                                currentSlideIndex = (n + slides.length) % slides.length;
                                slides[currentSlideIndex].classList.add('active');
                            };
                            leftHover.addEventListener('click', function() { showSlide(currentSlideIndex - 1); });
                            rightHover.addEventListener('click', function() { showSlide(currentSlideIndex + 1); });
                        }
                    });
                });

                map.addLayer(UKCluster);
                map.addLayer(NACluster);

            } catch (error) {
                console.error("Error loading projects from JSON:", error);
            }
        }

        document.addEventListener('DOMContentLoaded', fetchAndRenderMarkers);

        var circlesData = [
            { coords: [55.465208, -10.586449], tooltipText: "NA", targetViewCoords: NAcoords },
            { coords: [40.883785, -67.922996], tooltipText: "UK", targetViewCoords: UKcoords }
        ];

        circlesData.forEach(function(circleInfo) {
            var circle = L.circle(circleInfo.coords, {
                color: '#9333ea',
                fillColor: '#9333ea',
                fillOpacity: 0.5,
                radius: 100000
            }).addTo(map);

            circle.on('click', function(e) {
                map.setView(circleInfo.targetViewCoords, 6);
            });

            circle.bindTooltip(circleInfo.tooltipText);
        });
    </script>
</body>

</html>